---
- name: Deploy and start udapeople backend server
  hosts: web
  user: ubuntu
  gather_facts: false
  vars:
    - ansible_python_interpreter: /usr/bin/python3
    - ansible_host_key_checking: false
    - ansible_stdout_callback: yaml
  roles:
    - deploy
- name: Creates directory
  become: yes
  file:
    path: "/srv/stg"
    state: "directory"
    owner: ubuntu
    group: ubuntu
    mode: 0755

- name: Copy compressed backend folder
  copy:
    src: "/home/circleci/source/artifact.tar.gz"
    dest: "/srv/stg"

- name: Extract artifact
  unarchive:
    src: "/srv/stg/artifact.tar.gz"
    dest: "/srv/stg"
    remote_src: yes

- name: Start application
  command: |
    cd /srv/stg
    npm install
    npm run build
    pm2 stop default
    pm2 start npm -- start
  args:
    chdir: "/srv/stg"
